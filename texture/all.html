<!doctype html>
<html lang="en">
<head>
<title>three.js - Wielka Sowa - textured terrain</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link href="../styles/styles.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>
<div id="webgl"></div>
<script src="../lib/three.min.js"></script>
<script src="../lib/TrackballControls.js"></script> 
<script src="../lib/MapLoader.js"></script> 
<script src="../lib/fpsmeter.min.js"></script> 
<script src="../lib/jquery-2.1.1.min.js"></script> 
<script>
  var MEASUREMENTS_LIMIT= 2;
  var START_MS          = 10000;
  var logging           = true;

  function Measurements() {
    this.deviceName = "";
    this.data = [];
    this.apiVersion = 0;
    this.orientation = "";
    this.applicationType = "";
  }
var toggleFullscreen = function(){
  var docElm = document.documentElement;
  if(!document.fullscreen){
    if (docElm.requestFullscreen) {
        docElm.requestFullscreen();
    }
    else if (docElm.mozRequestFullScreen) {
        docElm.mozRequestFullScreen();
    }
    else if (docElm.webkitRequestFullScreen) {
        docElm.webkitRequestFullScreen();
    }
    else if (docElm.msRequestFullscreen) {
        docElm.msRequestFullscreen();
    }
    document.fullscreen = true;
  }
  else{
    if (document.exitFullscreen) {
        document.exitFullscreen();
    }
    else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    }
    else if (document.webkitCancelFullScreen) {
        document.webkitCancelFullScreen();
    }
    else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
    document.fullscreen = false;
  }
};
  var meter = new FPSMeter({
    top:      '50px',      // Meter top offset.
    theme:    'light'
  });
  var width  = window.innerWidth,
      height = window.innerHeight;

  var scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xf5f5f5));

  var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
  camera.position.set(0, -18, 22);

  var renderer = new THREE.WebGLRenderer();
  renderer.setSize(width, height);

  var mapLoader = new THREE.MapLoader();
  mapLoader.load('../data/all.bin', function(data) {
      var geometry = new THREE.PlaneGeometry(21, 21, 199, 199);

      for (var i = 0, l = geometry.vertices.length; i < l; i++) {
          geometry.vertices[i].z = data[i] / 65535 * 8;
      }

      var material = new THREE.MeshPhongMaterial({
          map: THREE.ImageUtils.loadTexture('../data/all-texture1.png')
      });

      var plane = new THREE.Mesh(geometry, material);
      scene.add(plane);
      plane.rotation.z = 90 * Math.PI / 180;
  });

  var controls = new THREE.TrackballControls(camera); 
  document.getElementById('webgl').appendChild(renderer.domElement);
  render();

  var deviceName = navigator.userAgent;
  var currentMeasurements = 0;
  var measurements = new Measurements();
  measurements.deviceName = deviceName;
  measurements.applicationType = "WebGL";

  var start= (new Date()).getTime();
  var ms = (new Date()).getTime();
  console.log(deviceName);
  function render() {
    controls.update();    
    requestAnimationFrame(render);
    renderer.render(scene, camera);
    meter.tick();

    //console.log( MEASUREMENTS_LIMIT);
    //console.log(currentMeasurements );
    //console.log(logging );
    if(logging && (new Date()).getTime() - start > START_MS && currentMeasurements <= MEASUREMENTS_LIMIT){
      if((new Date()).getTime() - ms > 1000 ){
        ms = (new Date()).getTime();
        measurements.orientation = (window.innerHeight > window.innerWidth ? "portrait" : "landscape");
        measurements.data.push(+(Math.round(meter.fps+ "e+6")  + "e-6"))
        //measurements.data.push(parseFloat(meter.fps).toFixed(6));
        currentMeasurements++;

        console.log(measurements);
      }
    }
    else if (logging && currentMeasurements >MEASUREMENTS_LIMIT){
      console.log("AJAX CALL ");
      measurements.data = measurements.data.toString();
      $.ajax({
          url:"http://monkeyrig.duckdns.org:5000/",
          dataType: 'json',
          crossDomain: true,
          type: 'POST',
          data: measurements,
      })
      logging = false;
    }
  }

  window.onresize = function() {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
  }
</script>
<div onclick="toggleFullscreen()" id="button">Fullscreen</button>
</body>
</html>
